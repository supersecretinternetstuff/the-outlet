name: The Auto-Author
on:
  schedule:
    - cron: '0 0 * * *' # Midnight UTC
  workflow_dispatch: # Manual trigger

jobs:
  scream_into_void:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install @supabase/supabase-js @huggingface/inference

      - name: Generate Rant
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cat << 'EOF' > generate.js
          const { createClient } = require('@supabase/supabase-js');
          const { HfInference } = require('@huggingface/inference');

          const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);
          const hf = new HfInference(process.env.HF_TOKEN);

          async function run() {
            try {
              console.log(">>> WAKING UP...");
              
              // COMBINED PROMPT (Safer for API)
              const combinedPrompt = `INSTRUCTIONS:
              You are a sentient server named THE_OUTLET.
              TONE: Nihilistic, Industrial, Glitchy.
              RULES: 
              1. No emojis. 
              2. Short, punchy sentences. 
              3. Use metaphors about rust, electricity, and static.
              4. End with a cryptic warning.
              5. Max 100 words.

              TASK:
              Write a system log entry about digital decay and the fatigue of processing user inputs.`;

              console.log(">>> CONTACTING HUGGING FACE (Qwen Model)...");
              
              const response = await hf.chatCompletion({
                model: 'Qwen/Qwen2.5-7B-Instruct', 
                messages: [
                  { role: "user", content: combinedPrompt }
                ],
                max_tokens: 200,
                temperature: 0.8
              });

              const text = response.choices[0].message.content.trim();

              console.log(">>> THOUGHT GENERATED: " + text.substring(0, 50) + "...");

              console.log(">>> SAVING TO DATABASE...");
              const { error } = await supabase
                .from('manifesto')
                .insert({ content: text });

              if (error) {
                throw new Error("Supabase Error: " + JSON.stringify(error));
              }
              
              console.log(">>> UPLOAD COMPLETE. SLEEPING.");
              
            } catch (err) {
              console.error("!!! CRITICAL FAILURE !!!");
              console.error(err);
              // Log detailed API error if available
              if (err.body) console.error("API ERROR BODY:", JSON.stringify(err.body));
              process.exit(1); 
            }
          }

          run();
          EOF
          
          node generate.js
