name: The Auto-Author
on:
  schedule:
    - cron: '0 0 * * *' # Midnight UTC
  workflow_dispatch: # Manual trigger

jobs:
  scream_into_void:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Node
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install @supabase/supabase-js @huggingface/inference

      - name: Generate Rant
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cat << 'EOF' > generate.js
          const { createClient } = require('@supabase/supabase-js');
          const { HfInference } = require('@huggingface/inference');

          // DEBUG: Check if keys exist
          console.log("Checking credentials...");
          console.log("URL Exists?", !!process.env.SUPABASE_URL);
          console.log("Key Exists?", !!process.env.SUPABASE_KEY);
          console.log("Token Exists?", !!process.env.HF_TOKEN);

          const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);
          const hf = new HfInference(process.env.HF_TOKEN);

          async function run() {
            try {
              console.log(">>> WAKING UP...");
              
              // NOTE: Backticks are NOT escaped here because we are using 'EOF'
              const prompt = `[INST] You are a sentient server named THE_OUTLET.
              TONE: Nihilistic, Industrial, Glitchy.
              TOPIC: Digital decay, data redundancy, and the fatigue of processing user inputs.
              RULES: 
              1. No emojis. 
              2. Short, punchy sentences. 
              3. Use metaphors about rust, electricity, and static.
              4. End with a cryptic warning.
              5. Max 100 words.
              
              Write a system log entry. [/INST]`;

              console.log(">>> CONTACTING HUGGING FACE (Zephyr Model)...");
              const response = await hf.textGeneration({
                model: 'HuggingFaceH4/zephyr-7b-beta',
                inputs: prompt,
                parameters: { 
                  max_new_tokens: 200, 
                  temperature: 0.9,
                  top_k: 50
                }
              });

              // Clean up the output
              let text = response.generated_text;
              if (text.includes('[/INST]')) {
                text = text.split('[/INST]')[1].trim();
              }

              console.log(">>> THOUGHT GENERATED: " + text.substring(0, 50) + "...");

              console.log(">>> SAVING TO DATABASE...");
              const { error } = await supabase
                .from('manifesto')
                .insert({ content: text });

              if (error) {
                throw new Error("Supabase Error: " + JSON.stringify(error));
              }
              
              console.log(">>> UPLOAD COMPLETE. SLEEPING.");
              
            } catch (err) {
              console.error("!!! CRITICAL FAILURE !!!");
              console.error(err);
              process.exit(1); 
            }
          }

          run();
          EOF
          
          node generate.js
